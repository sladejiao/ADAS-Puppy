Trajectory Generator                                                                                                                                                                                                                                                                                                                                                                                      

author: Slade

记录在Predicition 模块中最终生成预测轨迹的方法和思考

参考apollo planning 的分类方法

Public road 代表被静态语义和交通规则强约束

OpenSpace 特指类似收费站/无强约束未知场景(或者说非Scenario可认的白名单场景)

# Public Road

## Lane Follow

in lane 和 junction 在Genarator中的定义:

inlane 指被感知层的真实道线约束

junction 指路口被逻辑层的虚拟道线约束

问题来源:当intention predictor(意图预测)中有了指定的某个意图,根据其意图生成轨迹

正如整个循线意图预测的描述,intention最终是给出了一个target lane 的id

### reference line

参考线是Genarator的输入,也是核心,来源于意图预测

在大部分的case中,以点集的形式表达出来

当然,一般来说lane和line的概念不同,在这里line是lane的虚拟中心线

同时考虑整个生成器的形式,一般是在SL坐标系考虑的

这根target line 同时也是Frenet转换的中心道线

### 一些讨论

这里先进行一些思考性的讨论,当描述循线这个行为的时候,为了方便生成轨迹,最合理的描述是从(当前的位置)到沿着target line 行驶

我们来思考一个变道问题,那么势必有变道过程,和循线过程,这也是接下来以规则coding的中心思想,但是这里有合理的规则吗

#### 应用

探索性的讲,即使是同一个驾驶员,在变道过程中的连续性运动模型也是不同的,换句话说,每一次变道都是独立事件,只能说,由于其运动学的特性,我们认为其在统计学上是有可能找到置信区间的

即使将来以data来驱动,我认为其预测也很难在变道过程中表现得非常非常好,宏观来说,变道的时长,变道的距离,我们只能找到一部分特征,尤其在考虑博弈的时候,又由于主动安全和行车出发点的不同,这种轨迹的生成在避免AEB误触发的时候很有好处,但是这类轨迹引起AEB触发则需要非常慎重

#### 如何更精准

Brain storming , 当data base 时,虽然资源上很难实现,但是诸如变道/转弯等行为,除了在显性上是否和车速/道路结构相关

隐形上和地区(地形导致的驾驶风格),目标车的subtype(宏观上跑车肯定比MPV激进),因此转化的问题是,不管是不是end to end 导致无法监管中间过程还是 伪one model 的 model chain ,在数据上,需要有这样的labeling

#### 是否可以在ODO考虑

可以是可以的,取决于制定的规则究竟是什么,当你把变道过程描述为向index集的贴合过程,其本质和XY2SL就没有区别了,甚至在寻点时更加麻烦,但是考虑诸如图优化方法好像是可以的,但是没有实现经验

### Driving 的实现

#### 描述

理解为固定有两端:

1.贴合过程(由k时刻目标位置向target line)

2.循线过程

#### 运动学描述

XY 下运动学:
$$
{x,y,v_x,v_y,a_x,a_y,\theta}
$$
找到Frenet下参考点${Pt_{frenet}}$

根据这个点的${\theta_{ref}}$得到frent下的v/a
$$
s,l,v_s,v_l,a_s.a_l
$$
并且在全时段,认为SL下S的状态以CA进行迭代
$$
s = s_0 + v_s\times{t_{step}}+0.5\times{a_s}\times{t_{step}}^2
$$
假设切合过程有两个约束

变道时间/变道长度:

$t_{merge}$ / ${Length_{merge}}$ 并取||

在切合过程中,以s的值为自变量以5次多项式的形式逼近横向过程
$$
l = c_5 * s^5 + c_4 * s^4 + c_3 * s^3 + c_2 * s^2 + c_1 * s + c_0
$$
然后确定整个运动学过程
$$
{x,y} = SL2XY(s,l)\\
\theta = arctan(y_i-y_{i-1},x_i-x_{i-1})\\
v = \sqrt{(x_i-x_{i-1})^2 + (y_i-y_{i-1})^2}\\
v_x = cos(\theta)\\
v_y = sin(\theta)\\
a 用v迭代,同理
$$
那么可以得出结论 ,一共两个假设:

1. s维运动学不变
2. 5次多项式固定拟合

### 主动安全的实现

事实上AS的实现在看Driving的代码前就已经完成

同样也是分为了贴合部分和循线部分

这里解释为什么描述为贴合部分是因为和行车的三车道模型不同,AS本身循的就是真实道线,那么即使意图为KeepLane,依旧会有贴合部分

可以理解为纵向上同样以CA模型,只不过直接由OpenSpace的轨迹的信息直接转为S维信息

注意,由于ref_line的theta在不停变化,因此即使是纵向信息,两者的实现也是不同的

在L向上,直接使用了CV模型(5次多项式的系数真的好调吗)

TODO(可以考虑ALCA的贝塞尔控制模型来替代当前的CA),但是其问题是你的规划永远在变化,连续性肯定是不如简单的CV或者CA,但是后者的问题在于轨迹在速度维的信息会有突变,当然可以增加衰减系数,但是本质上和多项式的方法是相同的